trigger:
- main

pool:
  Default

steps:
  - script: |
      python -m pip install --upgrade pip
      pip install -r requirements.txt
    displayName: 'Install dependencies'

  - task: ArchiveFiles@2
    displayName: 'Archive files'
    inputs:
      rootFolderOrFile: $(System.DefaultWorkingDirectory)
      includeRootFolder: false
      archiveType: zip
      archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-$(python.version).zip
      replaceExistingArchive: true

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: '$(Build.ArtifactStagingDirectory)'
      ArtifactName: 'drop'
      publishLocation: 'Container'

  - task: Docker@2
    displayName: Login to Docker Hub
    inputs:
      command: login
      containerRegistry: 'docker-hub'
  - task: Docker@2
    inputs:
      containerRegistry: 'docker-hub'
      repository: 'hello_app'
      command: 'buildAndPush'
      Dockerfile: '**/Dockerfile'

  - script: |
      pip install pytest pytest-azurepipelines
      pytest
    displayName: 'pytest'